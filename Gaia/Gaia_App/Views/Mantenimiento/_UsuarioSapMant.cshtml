@model  Gaia.DAL.Model.Usuario

@Html.Hidden("hfidUsuario")
<div class="content">
    <div class="flex-grid">
        <div class="row padding10 flex-jus-center">
            <div class="cell size12 padding10 no-padding-left">
                <div data-role="window" class="window">
                    <div class="window-caption">
                        <span class="window-caption-title">Usuario</span>
                    </div>
                    <div class="window-content">
                        <div class="row flex-just-center">
                            <div class="cell size6">
                                <div class="row flex-just-center">
                                    <div class="cell size6">
                                        <label class="input-control text full-size">
                                            @Html.TextBoxFor(model => model.UsuarioId, new { id = "txtLoginId", PlaceHolder = "Login" })
                                            @Html.ValidationMessage("loginid", "* Campo Requerido *", new { id = "lblloginid", @style = "color:red; display: none;" })
                                        </label>
                                    </div>
                                </div>
                                <div class="row flex-just-center">
                                    <div class="cell size6">
                                        <label class="input-control password full-size">
                                            @Html.TextBoxFor(model => model.Password, new { id = "txtPassword", type = "password", PlaceHolder = "Contraseña" })
                                            @Html.ValidationMessage("password", "* Campo Requerido *", new { id = "lblpassword", @style = "color:red; display: none;" })
                                        </label>
                                    </div>
                                </div>
                                <div class="row flex-just-center">
                                    <div class="cell size6">
                                        <label class="input-control text full-size">
                                            @Html.TextBoxFor(model => model.Correo, new { id = "txtCorreo", PlaceHolder = "Correo" })
                                            @Html.ValidationMessage("correo", "* Campo Requerido *", new { id = "lblcorreo", @style = "color:red; display: none;" })
                                        </label>
                                    </div>
                                </div>
                                <div class="row flex-just-center">
                                    <div class="cell size6">
                                        <label class="input-control text full-size">
                                            @Html.DropDownListFor(model => model.Persona.TipoIdentificadorId, new SelectList(ViewBag.TipoIdentificacion as System.Collections.IEnumerable, "IdTipoIdentificacion", "NombreTipoIdentificacion"),
                                            "Selecciona Tipo", new { id = "txtIdentificadorId", @class = "int" })
                                            @Html.ValidationMessage("identificadortipo", "* Campo Requerido *", new { id = "lblidentificadortipo", @style = "color:red; display: none;" })
                                        </label>
                                    </div>
                                </div>
                                <div class="row flex-just-center">
                                    <div class="cell size6">
                                        <label class="input-control text full-size">
                                            @Html.TextBoxFor(model => model.Persona.Identificador, new { id = "txtIdentificador", PlaceHolder = "Identificador" })
                                            @Html.ValidationMessage("identificador", "* Campo Requerido *", new { id = "lblidentificador", @style = "color:red; display: none;" })
                                        </label>
                                    </div>
                                </div>
                                <div class="row flex-just-center" id="blnActivoUsu">
                                    <label class="input-control checkbox small-check">
                                        <input type="checkbox" id="activoblnActivo" value="true" checked>
                                        <span class="check"></span>
                                        <span class="caption">Activo</span>
                                    </label>
                                    <label class="input-control checkbox small-check">
                                        <input type="checkbox" id="inactivoblnActivo" value="false">
                                        <span class="check"></span> 
                                        <span class="caption">Inactivo</span>
                                    </label>
                                </div>                               
                            </div>
                            <div class="cell size6">
                                <div class="row flex-just-center">
                                    <div class="cell size6">
                                        <label class="input-control text full-size">
                                            @Html.DropDownListFor(model => model.Persona.strEntidad, new SelectList(ViewBag.Entidadpj as System.Collections.IEnumerable, "intCodEntidadPJ", "DescripcionCompleta"),
                                            "Selecciona Entidad", new { id = "txtintCodEntidadPJ", @class = "ent" })
                                            @Html.ValidationMessage("intCodEntidadPJ", "* Campo Requerido *", new { id = "lblintcodentidadpjl", @style = "color:red; display: none;" })
                                        </label>
                                    </div>
                                </div>
                                <div class="row flex-just-center">
                                    <div class="cell size6">
                                        <label class="input-control text full-size">
                                            @Html.TextBoxFor(model => model.Persona.strNombreCompleto, new { id = "txtNombre1", PlaceHolder = "1er. Nombre" })
                                            @Html.ValidationMessage("nombre1", "* Campo Requerido *", new { id = "lblnombre1", @style = "color:red; display: none;" })
                                        </label>
                                    </div>
                                </div>
                                <div class="row flex-just-center">
                                    <div class="cell size6">
                                        <label class="input-control text full-size">
                                            @Html.TextBoxFor(model => model.Persona.strNombreCompleto, new { id = "txtNombre2", PlaceHolder = "2do. Nombre" })
                                            @Html.ValidationMessage("nombre2", "* Campo Requerido *", new { id = "lblnombre2", @style = "color:red; display: none;" })
                                        </label>
                                    </div>
                                </div>
                                <div class="row flex-just-center">
                                    <div class="cell size6">
                                        <label class="input-control text full-size">
                                            @Html.TextBoxFor(model => model.Persona.strNombreCompleto, new { id = "txtApellido1", PlaceHolder = "1er. Apellido" })
                                            @Html.ValidationMessage("apellido1", "* Campo Requerido *", new { id = "lblapellido1", @style = "color:red; display: none;" })
                                        </label>
                                    </div>
                                </div>
                                <div class="row flex-just-center">
                                    <div class="cell size6">
                                        <label class="input-control text full-size">
                                            @Html.TextBoxFor(model => model.Persona.strNombreCompleto, new { id = "txtApellido2", PlaceHolder = "2do. Apellido" })
                                            @Html.ValidationMessage("apellido2", "* Campo Requerido *", new { id = "lblapellido2", @style = "color:red; display: none;" })
                                        </label>
                                    </div>
                                </div>
                                <div class="row flex-just-center" id="blnDeBajaUsu">
                                    <label class="input-control checkbox small-check">
                                        <input type="checkbox" id="activoblnDeBaja" value="true" >
                                        <span class="check"></span>
                                        <span class="caption">DeBaja</span>
                                    </label>
                                    <label class="input-control checkbox small-check">
                                        <input type="checkbox" id="inactivoblnDeBaja" value="false" checked>
                                        <span class="check"></span>
                                        <span class="caption">Alta</span>
                                    </label>
                                </div>
                            </div>
                            <div class="cell size3">
                                <div class="tile-square" data-role="tile">
                                    <div class="row flex-just-center">
                                        <div class="image-container" id="Avatar" style="display:contents">
                                            <div class="frame"><img id="idavatar" src="anonymous.png" class="imagen-circle"></div>
                                        </div>
                                    </div>
                                    <div class="row flex-just-center">
                                        <div class="input-control file" data-role="input">
                                            <input type="file" name="file" id="file" onchange="MostrarImagen()" accept="image/x-png" />
                                            <button class="button"><span class="mif-folder"></span></button>
                                        </div>
                                    </div>                                    
                                </div>
                            </div>
                        </div>
                        <div class="row flex-just-center">
                            <div class="toolbar">
                                <div class="toolbar-section">
                                    <button class="image-button ribbed-darkBlue" data-tabcontinuar="data-tabcontinuar" onclick="AgregarUsuarioSap()" id="btnGuardaUsuarioSap">
                                        <span class="fg-white">Guardar</span>
                                        <span class="icon mif-floppy-disk fg-white bg-darkBlue"></span>
                                    </button>
                                    <button class="image-button ribbed-darkOrange" data-tabcontinuar="data-tabcontinuar" id="btnActualizarUsuarioSap" style="display: none" onclick="ActualizarUsuarioSap()"> 
                                        <span class="fg-white">Actualizar</span>
                                        <span class="icon mif-pencil fg-white bg-darkOrange"></span>
                                    </button>
                                    <button class="image-button ribbed-darkEmerald" data-tabcontinuar="data-tabcontinuar" id="btnNuevoUsuarioSap" onclick="NuevaUsuarioSap()">
                                        <span class="fg-white">Nuevo</span>
                                        <span class="icon mif-plus fg-white bg-darkEmerald"></span>
                                    </button>                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@using (Html.BeginScriptContext())
{
    Html.AddScriptBlock(
        @<script type="text/javascript">
            $(document).ready(function () {
                $("#idavatar").attr("src", obtenerURL('/Content/Images/anonymous.png'));

                $(".ent").select2({
                    placeholder: "Seleccione Entidad", dropdownAutoWidth: true, tags: true,
                });

                $(".int").select2({
                    placeholder: "Seleccione Tipo Identificador", dropdownAutoWidth: true, tags: true, width: '100%',
                });

                $('#blnDeBajaUsu input[type=checkbox]').click(function () {
                    $('#blnDeBajaUsu input[type=checkbox]').prop("checked", false);
                    $(this).prop("checked", true);
                });

                $('#blnActivoUsu input[type=checkbox]').click(function () {
                    $('#blnActivoUsu input[type=checkbox]').prop("checked", false);
                    $(this).prop("checked", false);
                });
            });

            function AgregarUsuarioSap() {
                var bandera = true;

                if ($('#txtLoginId').val().toString().length < 1) {
                    $("#lblloginid").show();
                    bandera = false;
                }
                if ($('#txtPassword').val().toString().length < 1) {
                    $("#lblpassword").show();
                    bandera = false;
                }
                if ($('#txtCorreo').val().toString().length < 1) {
                    $("#lblcorreo").show();
                    bandera = false;
                }
                if ($('#txtIdentificadorId').val().toString().length < 1) {
                    $("#lblidentificadortipo").show();
                    bandera = false;
                }
                if ($('#txtIdentificador').val().toString().length < 1) {
                    $("#lblidentificador").show();
                    bandera = false;
                }
                if ($('#txtintCodEntidadPJ').val().toString().length < 1) {
                    $("#lblintcodentidadpjl").show();
                    bandera = false;
                }
                if ($('#txtNombre1').val().toString().length < 1) {
                    $("#lblnombre1").show();
                    bandera = false;
                }
                if ($('#txtApellido1').val().toString().length < 1) {
                    $("#lblapellido1").show();
                    bandera = false;
                }

                if (bandera == true) {
                    $("#lblloginid").hide();
                    $("#lblpassword").hide();
                    $("#lblcorreo").hide();
                    $("#lblidentificadortipo").hide();
                    $("#lblidentificador").hide();
                    $("#lblintcodentidadpjl").hide();
                    $("#lblnombre1").hide();
                    $("#lblapellido1").hide();
                    var request;

                    var listaCheck = $("#blnActivoUsu input[type='checkbox']");
                    $.each(listaCheck, function (index, value) {
                        if ($(value).prop('checked') === true) {
                            Activo = value.value
                        }
                    });

                    var listaCheck1 = $("#blnDeBajaUsu input[type='checkbox']");
                    $.each(listaCheck1, function (index, value) {
                        if ($(value).prop('checked') === true) {
                            DeBaja = value.value
                        }
                    });

                    var usuariojson = JSON.stringify({ "IdPadre": "0", "nombre_usuario": $("#txtLoginId").val(), "contrasenna": "pass123", "blnActivo": Activo, "DeBaja": DeBaja, "intCodEntidadPJ": $("#txtintCodEntidadPJ").val() });
                    var personajson = JSON.stringify({ "IdTipoIdentificacion": $("#txtIdentificadorId").val(), "Identificacion": $("#txtIdentificador").val(), "primer_nombre": $('#txtNombre1').val(), "segundo_nombre": $('#txtNombre2').val(), "primer_apellido": $("#txtApellido1").val(), "segundo_apellido": $("#txtApellido2").val(), "email": $("#txtCorreo").val(), "intCodEntidadPJ": $("#txtintCodEntidadPJ").val(), "DeBaja": DeBaja, "blnActivo": Activo });
                    var Data = new FormData();
                    var files = $("#file").get(0).files;
                    if (files.length > 0) {
                        Data.append("file", files[0]);
                    }

                    $.ajax({
                        url: obtenerURL("/Mantenimiento/AgregarUsuarioSap?usuariojson=" + usuariojson + "&personajson=" + personajson + '&passwrd=' + $('#txtPassword').val()),
                        data: Data,
                        type: "post",
                        dataType: "json",
                        contentType: false,
                        processData: false,
                    }).done(function (strData) {
                        if (strData.Resultado === "true") {
                            $('#frUsuarioSap').empty();
                            $('#frUsuarioSap').load(obtenerURL("/Mantenimiento/ListaUsuarioSap"));
                            alertify.alert().destroy();
                            alertify.alert('Confirmación', strData.Mensaje);
                            alertify.alert().setting('modal', true);
                        }
                        else {
                            alertify.alert().destroy();
                            alertify.alert('Advertencia', listado.Mensaje);
                            alertify.alert().setting('modal', true);
                        }
                    });
                }
            }

            function ActualizarUsuarioSap() {
                var bandera = true;
                var personajson;

                if ($('#txtLoginId').val().toString().length < 1) {
                    $("#lblloginid").show();
                    bandera = false;
                }
                if ($('#txtPassword').val().toString().length < 1) {
                    $("#lblpassword").show();
                    bandera = false;
                }
                if ($('#txtCorreo').val().toString().length < 1) {
                    $("#lblcorreo").show();
                    bandera = false;
                }
                if ($('#txtIdentificadorId').val().toString().length < 1) {
                    $("#lblidentificadortipo").show();
                    bandera = false;
                }
                if ($('#txtIdentificador').val().toString().length < 1) {
                    $("#lblidentificador").show();
                    bandera = false;
                }
                if ($('#txtintCodEntidadPJ').val().toString().length < 1) {
                    $("#lblintcodentidadpjl").show();
                    bandera = false;
                }
                if ($('#txtNombre1').val().toString().length < 1) {
                    $("#lblnombre1").show();
                    bandera = false;
                }
                if ($('#txtApellido1').val().toString().length < 1) {
                    $("#lblapellido1").show();
                    bandera = false;
                }

                if (bandera == true) {
                    $("#lblloginid").hide();
                    $("#lblpassword").hide();
                    $("#lblcorreo").hide();
                    $("#lblidentificadortipo").hide();
                    $("#lblidentificador").hide();
                    $("#lblintcodentidadpjl").hide();
                    $("#lblnombre1").hide();
                    $("#lblapellido1").hide();
                    var request;

                    var listaCheck = $("#blnActivoUsu input[type='checkbox']");
                    $.each(listaCheck, function (index, value) {
                        if ($(value).prop('checked') === true) {
                            Activo = value.value
                        }
                    });

                    var listaCheck1 = $("#blnDeBajaUsu input[type='checkbox']");
                    $.each(listaCheck1, function (index, value) {
                        if ($(value).prop('checked') === true) {
                            DeBaja = value.value
                        }
                    });
                    
                    if (DeBaja == "true") {                    
                        personajson = JSON.stringify({ "IdTipoIdentificacion": $("#txtIdentificadorId").val(), "Identificacion": $("#txtIdentificador").val(), "primer_nombre": $('#txtNombre1').val(), "segundo_nombre": $('#txtNombre2').val(), "primer_apellido": $("#txtApellido1").val(), "segundo_apellido": $("#txtApellido2").val(), "email": $("#txtCorreo").val(), "intCodEntidadPJ": $("#txtintCodEntidadPJ").val(), "DeBaja": DeBaja, "FechaBaja": formatFechaHoras(new Date), "blnActivo": Activo });
                    }
                    else {                        
                        personajson = JSON.stringify({ "IdTipoIdentificacion": $("#txtIdentificadorId").val(), "Identificacion": $("#txtIdentificador").val(), "primer_nombre": $('#txtNombre1').val(), "segundo_nombre": $('#txtNombre2').val(), "primer_apellido": $("#txtApellido1").val(), "segundo_apellido": $("#txtApellido2").val(), "email": $("#txtCorreo").val(), "intCodEntidadPJ": $("#txtintCodEntidadPJ").val(), "DeBaja": DeBaja, "blnActivo": Activo });
                    }

                    var usuariojson = JSON.stringify({ "IdPadre": "0", "nombre_usuario": $("#txtLoginId").val(), "contrasenna": "pass123", "blnActivo": Activo, "DeBaja": DeBaja, "intCodEntidadPJ": $("#txtintCodEntidadPJ").val() });

                    var Data = new FormData();
                    var files = $("#file").get(0).files;
                    if (files.length > 0) {
                        Data.append("file", files[0]);
                    }else { Data = "null" }

                    $.ajax({
                        url: obtenerURL("/Mantenimiento/ActualizarUsuarioSap?usuariojson=" + usuariojson + "&personajson=" + personajson + "&passwrd=" + $("#txtPassword").val() + "&idusuario=" + $("#hfidUsuario").val()),
                        data: Data,
                        type: "post",
                        dataType: "json",
                        contentType: false,
                        processData: false,
                    }).done(function (strData) {
                        if (strData.Resultado === "true") {
                            $('#frUsuarioSap').empty();
                            $('#frUsuarioSap').load(obtenerURL("/Mantenimiento/ListaUsuarioSap"));
                            alertify.alert().destroy();
                            alertify.alert('Confirmación', strData.Mensaje);
                            alertify.alert().setting('modal', true);
                        }
                        else {
                            alertify.alert().destroy();
                            alertify.alert('Advertencia', listado.Mensaje);
                            alertify.alert().setting('modal', true);
                        }
                    });
                }
            }

            function NuevaUsuarioSap() {
                $("#idavatar").attr("src", obtenerURL('/Content/Images/anonymous.png'))
                $('#txtLoginId').prop("disabled", false);
                $('#txtLoginId').val("");
                $('#txtPassword').val("");
                $('#txtCorreo').val("");
                $('#txtAvatar').val("");
                $('#txtIdentificadorId').select2("val", "ca");
                $('#txtIdentificador').val("");
                $("#activoblnActivo").prop("checked", true);
                $("#inactivoblnActivo").prop("checked", false);
                $('#txtintCodEntidadPJ').select2("val", "ca");
                $('#txtintCodEntidadPJ').prop("disabled", false);
                $('#txtNombre1').val("");
                $('#txtNombre1').prop("disabled", false);
                $('#txtNombre2').val("");
                $('#txtNombre2').prop("disabled", false);
                $('#txtApellido1').val("");
                $('#txtApellido1').prop("disabled", false);
                $('#txtApellido2').val("");
                $('#txtApellido2').prop("disabled", false);
                $("#activoblnDeBaja").prop("checked", false);
                $("#inactivoblnDeBaja").prop("checked", true);                
                $('#btnActualizarUsuarioSap').hide();
                $('#btnGuardaUsuarioSap').show();
            }

            function MostrarImagen() {
                $("#Avatar").empty();
                var files = $("#file").get(0).files[0];
                    var reader = new FileReader();
                    reader.onload = (function (theFile) {
                        return function (e) {
                            document.getElementById("Avatar").innerHTML = ['<div class="frame"><img class="thumb" id="idavatar" name="avatar" src="', e.target.result, '" /></div>'].join('');
                        };
                    })(files);
                    reader.readAsDataURL(files);
            }
        </script>
    , true);
}
